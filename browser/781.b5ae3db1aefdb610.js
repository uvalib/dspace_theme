"use strict";(self.webpackChunkdspace_angular=self.webpackChunkdspace_angular||[]).push([[781,2355],{10781:(J,C,o)=>{o.d(C,{w:()=>v});var E=o(60177),t=o(54438),c=o(89417),T=o(41780),W=o(48376),y=o.n(W),S=o(84412),F=o(44668),b=o(22806),$=o(84572),x=o(96697),G=o(96354),U=o(73028),L=o(88141),K=o(67116),A=o(96526),B=(o(76829),o(80183)),R=o(16292),g=o(60456),m=o(82777),M=o(39806),u=o(74448),V=(o(67478),o(62355)),j=o(52149);function D(i,h){if(1&i&&t.nrm(0,"ds-type-badge",17),2&i){const s=t.XpG(3);t.Y8G("object",s.dso)}}function H(i,h){if(1&i&&(t.j41(0,"span",15),t.DNE(1,D,1,1,"ds-type-badge",16),t.k0s()),2&i){const s=t.XpG(2);t.R7$(),t.Y8G("ngIf",!!s.dso)}}function _(i,h){if(1&i&&(t.j41(0,"div",24),t.nrm(1,"input",25),t.j41(2,"label",26),t.EFF(3),t.nI1(4,"translate"),t.k0s()()),2&i){const s=h.$implicit;t.R7$(),t.Y8G("id","checkbox-"+s)("formControlName",s),t.R7$(),t.Y8G("for","checkbox-"+s),t.R7$(),t.JRh(t.bMT(4,4,"subscriptions.modal.new-subscription-form.frequency."+s))}}function l(i,h){1&i&&(t.j41(0,"ds-alert",27),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&i&&(t.Y8G("type","alert-danger"),t.R7$(),t.SpI(" ",t.bMT(2,2,"context-menu.actions.subscription.frequency.required")," "))}function d(i,h){if(1&i&&(t.j41(0,"fieldset",18)(1,"legend",19),t.EFF(2),t.nI1(3,"translate"),t.k0s(),t.j41(4,"div",20),t.nrm(5,"input",21),t.DNE(6,_,5,6,"div",22),t.k0s(),t.DNE(7,l,3,4,"ds-alert",23),t.k0s()),2&i){const s=h.$implicit,e=t.XpG(2);t.FS9("formGroupName",s.key),t.R7$(2),t.SpI(" ",t.bMT(3,5,"subscriptions.modal.new-subscription-form.type."+s.key),": "),t.R7$(3),t.Y8G("value",null==s||null==s.value?null:s.value.controls.subscriptionId.value),t.R7$(),t.Y8G("ngForOf",e.frequencyDefaultValues),t.R7$(),t.Y8G("ngIf",!!e.submitted&&(null==s||null==s.value||null==s.value.controls.frequencies.errors?null:s.value.controls.frequencies.errors.required))}}function r(i,h){1&i&&(t.j41(0,"p",28),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&i&&(t.R7$(),t.JRh(t.bMT(2,1,"subscriptions.modal.delete-info")))}function P(i,h){1&i&&(t.j41(0,"span"),t.nrm(1,"i",29),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&i&&(t.R7$(2),t.SpI(" ",t.bMT(3,1,"subscriptions.modal.new-subscription-form.processing")," "))}function N(i,h){1&i&&(t.j41(0,"span"),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&i&&(t.R7$(),t.SpI(" ",t.bMT(2,1,"subscriptions.modal.new-subscription-form.submit")," "))}function O(i,h){if(1&i){const s=t.RV6();t.j41(0,"form",1),t.bIt("ngSubmit",function(){t.eBV(s);const n=t.XpG();return t.Njj(n.submit())}),t.j41(1,"div",2)(2,"h4",3),t.EFF(3),t.nI1(4,"translate"),t.k0s(),t.j41(5,"button",4),t.bIt("click",function(){t.eBV(s);const n=t.XpG();return t.Njj(n.activeModal.close())}),t.j41(6,"span",5),t.EFF(7,"\xd7"),t.k0s()()(),t.j41(8,"div",6)(9,"p",7)(10,"strong"),t.EFF(11),t.k0s(),t.DNE(12,H,2,1,"span",8),t.k0s(),t.j41(13,"div"),t.DNE(14,d,8,7,"fieldset",9),t.nI1(15,"keyvalue"),t.k0s(),t.DNE(16,r,3,3,"p",10),t.nI1(17,"async"),t.k0s(),t.j41(18,"div",11)(19,"button",12),t.bIt("click",function(){t.eBV(s);const n=t.XpG();return t.Njj(n.activeModal.close())}),t.EFF(20),t.nI1(21,"translate"),t.k0s(),t.j41(22,"button",13),t.nI1(23,"async"),t.DNE(24,P,4,3,"span",14),t.nI1(25,"async"),t.DNE(26,N,3,3,"span",14),t.nI1(27,"async"),t.k0s()()()}if(2&i){const s=t.XpG();t.Y8G("formGroup",s.subscriptionForm),t.R7$(3),t.JRh(t.bMT(4,10,"subscriptions.modal.title")),t.R7$(8),t.JRh(s.dsoNameService.getName(s.dso)),t.R7$(),t.Y8G("ngIf",!!s.dso),t.R7$(2),t.Y8G("ngForOf",t.bMT(15,12,null==s.subscriptionForm?null:s.subscriptionForm.controls)),t.R7$(2),t.Y8G("ngIf",t.bMT(17,14,s.showDeleteInfo$)),t.R7$(4),t.SpI(" ",t.bMT(21,16,"subscriptions.modal.close")," "),t.R7$(2),t.Y8G("dsBtnDisabled",t.bMT(23,18,s.processing$)||!s.isValid),t.R7$(2),t.Y8G("ngIf",t.bMT(25,20,s.processing$)),t.R7$(2),t.Y8G("ngIf",!0!==t.bMT(27,22,s.processing$))}}let v=(()=>{class i{constructor(s,e,n,p,a,f,I,z){this.formBuilder=s,this.modalService=e,this.notificationsService=n,this.subscriptionService=p,this.activeModal=a,this.authService=f,this.translate=I,this.dsoNameService=z,this.processing$=new S.t(!1),this.showDeleteInfo$=new S.t(!1),this.submitted=!1,this.subscriptionDefaultTypes=["content"],this.frequencyDefaultValues=["D","W","M"],this.isValid=!1,this.updateSubscription=new t.bkB}ngOnInit(){this.authService.getAuthenticatedUserFromStore().pipe((0,x.s)(1),(0,G.T)(s=>s.uuid),(0,F.t)({refCount:!1})).subscribe(s=>{this.ePersonId=s,(0,m.hj)(this.subscription)?this.initFormByGivenSubscription():this.initFormByAllSubscriptions()}),this.subscriptionForm.valueChanges.subscribe(s=>{let e=!1;for(const n of this.frequencyDefaultValues)e=e||s.content.frequencies[n];this.isValid=e})}initFormByAllSubscriptions(){this.subscriptionForm=new c.J3({});for(const s of this.subscriptionDefaultTypes){const e=new c.J3({});e.addControl("subscriptionId",this.formBuilder.control("")),e.addControl("frequencies",this.formBuilder.group({}));for(const n of this.frequencyDefaultValues)e.controls.frequencies.addControl(n,this.formBuilder.control(!1));this.subscriptionForm.addControl(s,e)}this.initFormDataBySubscriptions()}initFormByGivenSubscription(){const s=new c.J3({});s.addControl("subscriptionId",this.formBuilder.control(this.subscription.id)),s.addControl("frequencies",this.formBuilder.group({})),s.get("frequencies").addValidators(c.k0.required);for(const e of this.frequencyDefaultValues){const n=-1!==y()(this.subscription.subscriptionParameterList,["value",e]);s.controls.frequencies.addControl(e,this.formBuilder.control(n))}this.subscriptionForm=this.formBuilder.group({[this.subscription.subscriptionType]:s})}initFormDataBySubscriptions(){this.processing$.next(!0),this.subscriptionService.getSubscriptionsByPersonDSO(this.ePersonId,this.dso?.uuid).pipe((0,B.ak)()).subscribe({next:s=>{if(s.pageInfo.totalElements>0){this.showDeleteInfo$.next(!0);for(const e of s.page){const p=this.subscriptionForm.get(e.subscriptionType);if((0,m.hj)(p)){p.controls.subscriptionId.setValue(e.id);for(const a of e.subscriptionParameterList.filter(f=>"frequency"===f.name))p.controls.frequencies.controls[a.value]?.setValue(!0)}}}this.processing$.next(!1)},error:s=>{this.processing$.next(!1)}})}submit(){this.submitted=!0;const s=Object.keys(this.subscriptionForm.controls),e=[],n=[];s.forEach(a=>{const f=this.subscriptionForm.controls[a];if(f.touched&&f.dirty){const I=this.createBody(f.controls.subscriptionId.value,a,f.controls.frequencies);(0,m.hj)(I.id)?n.push(I):(0,m.hj)(I.subscriptionParameterList)&&e.push(I)}});const p=[];(0,m.hj)(e)&&p.push((0,b.H)(e).pipe((0,U.Z)(a=>this.subscriptionService.createSubscription(a,this.ePersonId,this.dso.uuid).pipe((0,B.qD)())),(0,L.M)(a=>{if(a.hasSucceeded){const f=this.translate.instant("subscriptions.modal.create.success",{type:a.payload.subscriptionType});this.notificationsService.success(null,f)}else this.notificationsService.error(null,this.translate.instant("subscriptions.modal.create.error"))}))),(0,m.hj)(n)&&p.push((0,b.H)(n).pipe((0,U.Z)(a=>this.subscriptionService.updateSubscription(a,this.ePersonId,this.dso.uuid).pipe((0,B.qD)())),(0,L.M)(a=>{if(a.hasSucceeded){const f=this.translate.instant("subscriptions.modal.update.success",{type:a.payload.subscriptionType});this.notificationsService.success(null,f),(0,m.hj)(this.subscription)&&this.updateSubscription.emit(a.payload)}else this.notificationsService.error(null,this.translate.instant("subscriptions.modal.update.error"))}))),(0,$.z)([...p]).subscribe(a=>{this.activeModal.close()})}createBody(s,e,n){const p={id:(0,m.hj)(s)?s:null,subscriptionType:e,subscriptionParameterList:[]};for(const a of this.frequencyDefaultValues)n.value[a]&&p.subscriptionParameterList.push({name:"frequency",value:a});return p}static{this.\u0275fac=function(e){return new(e||i)(t.rXU(c.ze),t.rXU(j.Bq),t.rXU(M.I),t.rXU(V.SubscriptionsDataService),t.rXU(j.Lw),t.rXU(K.uR),t.rXU(T.c$),t.rXU(A.f))}}static{this.\u0275cmp=t.VBU({type:i,selectors:[["ds-subscription-modal"]],inputs:{dso:"dso",subscription:"subscription"},outputs:{updateSubscription:"updateSubscription"},standalone:!0,features:[t.aNF],decls:1,vars:1,consts:[["data-test","subscription-form",3,"formGroup","ngSubmit",4,"ngIf"],["data-test","subscription-form",3,"ngSubmit","formGroup"],[1,"modal-header"],[1,"modal-title"],["type","button","aria-label","Close",1,"close",3,"click"],["aria-hidden","true"],[1,"modal-body"],[1,"mb-3"],["class","float-right",4,"ngIf"],["class","form-group form-row",3,"formGroupName",4,"ngFor","ngForOf"],["class","text-muted",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","submit",1,"btn","btn-success",3,"dsBtnDisabled"],[4,"ngIf"],[1,"float-right"],[3,"object",4,"ngIf"],[3,"object"],[1,"form-group","form-row",3,"formGroupName"],[1,"col-md-4","col-form-label","float-md-left","pt-0"],[1,"col-md-8"],["type","hidden","formControlName","subscriptionId",3,"value"],["class","form-check","formGroupName","frequencies",4,"ngFor","ngForOf"],[3,"type",4,"ngIf"],["formGroupName","frequencies",1,"form-check"],["type","checkbox",1,"form-check-input",3,"id","formControlName"],[1,"form-check-label",3,"for"],[3,"type"],[1,"text-muted"],[1,"fas","fa-circle-notch","fa-spin"]],template:function(e,n){1&e&&t.DNE(0,O,28,24,"form",0),2&e&&t.Y8G("ngIf",n.subscriptionForm)},dependencies:[E.bT,c.YN,c.qT,c.me,c.Zm,c.BC,c.cb,c.X1,c.j4,c.JD,c.$R,u.C,E.pM,R.C,E.Jj,E.lG,T.h,T.D9,g.A]})}}return i})()},62355:(J,C,o)=>{o.r(C),o.d(C,{SubscriptionsDataService:()=>j});var E=o(96697),t=o(96354),c=o(25558),T=o(5964),W=o(23294),y=o(91098),S=o(96526),F=o(72734),b=o(53954),$=o(41684),x=o(13617),G=o(63897),U=o(35108),L=o(12598),K=o(41023),A=o(43052),Y=o(32473),B=o(4910),R=o(80183),g=o(82777),m=o(39806),M=o(67600),u=o(54438),X=o(21626),V=o(25499);let j=(()=>{class D extends G.W{constructor(_,l,d,r,P,N,O,v,i){super("subscriptions",r,P,O,v),this.comparator=_,this.http=l,this.notificationsService=d,this.requestService=r,this.rdbService=P,this.store=N,this.objectCache=O,this.halService=v,this.nameService=i,this.findByEpersonLinkPath="findByEPerson",this.searchData=new U.X(this.linkPath,r,P,O,v,this.responseMsToLive),this.deleteData=new x.I(this.linkPath,r,P,O,v,d,this.responseMsToLive,this.constructIdEndpoint)}getSubscriptionsByPersonDSO(_,l){const d=Object.assign(new K._,{searchParams:[new b.x("resource",l),new b.x("eperson_id",_)]});return this.searchData.searchBy("findByEPersonAndDso",d,!1,!0)}createSubscription(_,l,d){return this.halService.getEndpoint(this.linkPath).pipe((0,g.VT)(),(0,E.s)(1),(0,t.T)(r=>`${r}?resource=${d}&eperson_id=${l}`),(0,t.T)(r=>new A.QU(this.requestService.generateRequestId(),r,JSON.stringify(_))),(0,y.w$)(this.requestService),(0,c.n)(r=>this.rdbService.buildFromRequestUUID(r.uuid)),(0,R.qD)())}updateSubscription(_,l,d){return this.halService.getEndpoint(this.linkPath).pipe((0,g.VT)(),(0,E.s)(1),(0,t.T)(r=>`${r}/${_.id}?resource=${d}&eperson_id=${l}`),(0,t.T)(r=>new A.v_(this.requestService.generateRequestId(),r,JSON.stringify(_))),(0,y.w$)(this.requestService),(0,c.n)(r=>this.rdbService.buildFromRequestUUID(r.uuid)),(0,R.qD)())}deleteSubscription(_){return this.halService.getEndpoint(this.linkPath).pipe((0,T.p)(l=>(0,g.hj)(l)),(0,W.F)(),(0,c.n)(l=>this.deleteData.delete(_)),(0,R.qD)())}findAllSubscriptions(_){return this.findAllData.findAll(_,!0,!0,(0,M.s)("resource"),(0,M.s)("eperson"))}findByEPerson(_,l){const d=Object.assign(new K._,l,{searchParams:[new b.x("uuid",_)]});return this.getEndpoint().pipe((0,t.T)(r=>`${r}/search/${this.findByEpersonLinkPath}`),(0,c.n)(r=>this.findListByHref(r,d,!1,!0,(0,M.s)("resource"),(0,M.s)("eperson"))))}static{this.\u0275fac=function(l){return new(l||D)(u.KVO(L.j),u.KVO(X.Qq),u.KVO(m.I),u.KVO(Y.B),u.KVO(F.o),u.KVO(V.il),u.KVO($.$),u.KVO(B.Y),u.KVO(S.f))}}static{this.\u0275prov=u.jDH({token:D,factory:D.\u0275fac,providedIn:"root"})}}return D})()}}]);